---
kind: pipeline
type: kubernetes
name: build
steps:
  - name: build
    image: docker:dind
    volumes:
    - name: dockersock
      path: /var/run
    environment:
      DOCKER_USERNAME: { from_secret: username }
      DOCKER_TOKEN: { from_secret: token }
    commands:
      - sleep 5
      - TAG=gitea.nkl.st/niklasrosenstein/jagrosh-musicbot:latest
      - docker login gitea.nkl.st -u "$DOCKER_USERNAME" -p "$DOCKER_TOKEN"
      - docker build . -t $TAG --cache-from $TAG --build-arg VERSION=0.3.8
      - docker push $TAG

services:
- name: docker
  image: docker:dind
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run
volumes:
- name: dockersock
  temp: {}

---
kind: secret
name: username
get:
  path: kv/data/gitea.nkl.st
  name: username

---
kind: secret
name: token
get:
  path: kv/data/gitea.nkl.st
  name: token
