---
kind: pipeline
type: kubernetes
name: build
steps:
  - name: build
    image: docker:dind
    volumes:
    - name: dockersock
      path: /var/run
    environment:
      DOCKER_USERNAME: { from_secret: docker_username }
      DOCKER_TOKEN: { from_secret: docker_token }
    commands:
      - sleep 5
      - docker build . -t niklasrosenstein/jagrosh-musicbot:latest --cache-from niklasrosenstein/jagrosh-musicbot:latest --build-arg VERSION=0.3.8
      - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_TOKEN"
      - docker push niklasrosenstein/jagrosh-musicbot:latest

services:
- name: docker
  image: docker:dind
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run
volumes:
- name: dockersock
  temp: {}

---
kind: secret
name: docker_username
get:
  path: kv/data/hub.docker.com
  name: username

---
kind: secret
name: docker_token
get:
  path: kv/data/hub.docker.com
  name: token
